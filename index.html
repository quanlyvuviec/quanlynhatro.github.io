<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Quản Lý Nhà Trọ</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover:not(:disabled),
        .btn-success:hover:not(:disabled),
        .btn-danger:hover:not(:disabled),
        .btn-warning:hover:not(:disabled),
        .btn-info:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .input-field {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 1200px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            padding: 30px;
        }
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .photo-upload {
            width: 120px;
            height: 160px;
            border: 3px dashed #cbd5e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }
        .photo-upload:hover {
            border-color: #667eea;
            background: #f7fafc;
        }
        .photo-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
        }
        .tab:hover {
            background: #f7fafc;
        }
        .room-group {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            background: #f8f9fa;
        }
        .room-group-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tenant-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-result-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        .highlight {
            background: yellow;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .photo-grid {
            display: flex;
            gap: 12px;
        }
        .photo-grid-item {
            width: 12cm;
            height: 9cm;
            border: 3px dashed #cbd5e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
            text-align: center;
        }
        .photo-grid-item:hover {
            border-color: #667eea;
            background: #f7fafc;
        }
        .photo-grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .photo-grid-item button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.8);
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        // === UTILITY FUNCTIONS ===
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        };
        const exportToExcel = (wb, filename) => {
            XLSX.writeFile(wb, `${filename}.xlsx`);
        };
        // IndexedDB Manager
        class DatabaseManager {
            constructor() {
                this.dbName = 'QuanLyNhaTroDB';
                this.version = 1;
                this.db = null;
            }
            async init() {
                if (this.db) return this.db;
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('nhaTros')) {
                            db.createObjectStore('nhaTros', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('khachDaTra')) {
                            db.createObjectStore('khachDaTra', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }
                    };
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                    request.onerror = (event) => reject(event.target.error);
                });
            }
            async getAll(storeName) {
                await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            async save(storeName, data) {
                await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.put(data);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
            async get(storeName, key) {
                await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            async delete(storeName, key) {
                await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.delete(key);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
            async saveAll(storeName, dataArray) {
                await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    dataArray.forEach(item => store.put(item));
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            }
        }
        const dbManager = new DatabaseManager();
        // Component chính
        function QuanLyNhaTro() {
            const [view, setView] = useState('home');
            const [nhaTros, setNhaTros] = useState([]);
            const [selectedNhaTro, setSelectedNhaTro] = useState(null);
            const [khachDaTra, setKhachDaTra] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [showChangePassword, setShowChangePassword] = useState(false);
            useEffect(() => {
                const loadData = async () => {
                    await dbManager.init();
                    const savedNhaTros = await dbManager.getAll('nhaTros');
                    setNhaTros(savedNhaTros);
                    const savedKhachDaTra = await dbManager.getAll('khachDaTra');
                    setKhachDaTra(savedKhachDaTra);
                };
                loadData();
            }, []);
            const saveData = async (data) => {
                setNhaTros(data);
                await dbManager.saveAll('nhaTros', data);
            };
            const saveKhachDaTra = async (data) => {
                setKhachDaTra(data);
                await dbManager.saveAll('khachDaTra', data);
            };
            const addOrUpdateNhaTro = async (nhaTro) => {
                let updated;
                if (nhaTro.id) {
                    updated = nhaTros.map(nt => nt.id === nhaTro.id ? nhaTro : nt);
                } else {
                    nhaTro.id = Date.now();
                    nhaTro.khachThue = [];
                    updated = [...nhaTros, nhaTro];
                }
                await saveData(updated);
                setView('home');
            };
            const deleteNhaTro = async (id) => {
                if (confirm('Bạn có chắc chắn muốn xóa nhà trọ này?')) {
                    const updated = nhaTros.filter(nt => nt.id !== id);
                    await saveData(updated);
                }
            };
            const filteredNhaTros = nhaTros.filter(nt =>
                nt.tenNhaTro.toLowerCase().includes(searchTerm.toLowerCase()) ||
                nt.diaChi.toLowerCase().includes(searchTerm.toLowerCase()) ||
                nt.cskv?.toLowerCase().includes(searchTerm.toLowerCase())
            );
            const handleLogout = () => {
                if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
                    setIsLoggedIn(false);
                    setView('home');
                }
            };
            const handleChangePassword = async (newCredentials) => {
                await dbManager.save('settings', { key: 'credentials', value: newCredentials });
                setShowChangePassword(false);
            };
            const handleBackup = async () => {
                const data = {
                    nhaTros: await dbManager.getAll('nhaTros'),
                    khachDaTra: await dbManager.getAll('khachDaTra'),
                    settings: await dbManager.get('settings', 'credentials')
                };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'backup_quanlynhatro.json';
                a.click();
                URL.revokeObjectURL(url);
            };
            const handleRestore = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const data = JSON.parse(event.target.result);
                        await dbManager.saveAll('nhaTros', data.nhaTros);
                        await dbManager.saveAll('khachDaTra', data.khachDaTra);
                        if (data.settings) {
                            await dbManager.save('settings', data.settings);
                        }
                        setNhaTros(data.nhaTros);
                        setKhachDaTra(data.khachDaTra);
                        alert('Dữ liệu đã được khôi phục!');
                        location.reload(); // Reload để cập nhật
                    };
                    reader.readAsText(file);
                }
            };
            const exportByCSKV = (cskv) => {
                const nhaTrosByCSKV = filteredNhaTros.filter(nt => nt.cskv?.toLowerCase() === cskv.toLowerCase());
                if (nhaTrosByCSKV.length === 0) {
                    alert('Không có nhà trọ nào cho CSKV này.');
                    return;
                }
                const wb = XLSX.utils.book_new();
                nhaTrosByCSKV.forEach(nt => {
                    const sheetName = nt.tenNhaTro.substring(0, 31); // Giới hạn tên sheet
                    const infoChung = [
                        ['Thông tin chung nhà trọ'],
                        ['Tên nhà trọ', nt.tenNhaTro],
                        ['Địa chỉ', nt.diaChi],
                        ['Số phòng', nt.soPhong],
                        ['CSKV', nt.cskv],
                        ['Chủ nhà họ tên', nt.chuNha?.hoTen || ''],
                        ['Chủ nhà CCCD', nt.chuNha?.canCuoc || ''],
                        ['Chủ nhà HKTT', nt.chuNha?.hktt || ''],
                        ['Chủ nhà Nơi ở hiện tại', nt.chuNha?.noiOHienTai || ''],
                        ['Chủ nhà SĐT', nt.chuNha?.soDienThoai || ''],
                        ['Người thuê họ tên', nt.nguoiThue?.hoTen || ''],
                        ['Người thuê CCCD', nt.nguoiThue?.canCuoc || ''],
                        ['Người thuê HKTT', nt.nguoiThue?.hktt || ''],
                        ['Người thuê Nơi ở hiện tại', nt.nguoiThue?.noiOHienTai || ''],
                        ['Người thuê SĐT', nt.nguoiThue?.soDienThoai || ''],
                        ['Người quản lý họ tên', nt.nguoiQuanLy?.hoTen || ''],
                        ['Người quản lý CCCD', nt.nguoiQuanLy?.canCuoc || ''],
                        ['Người quản lý HKTT', nt.nguoiQuanLy?.hktt || ''],
                        ['Người quản lý Nơi ở hiện tại', nt.nguoiQuanLy?.noiOHienTai || ''],
                        ['Người quản lý SĐT', nt.nguoiQuanLy?.soDienThoai || ''],
                        ['Camera', nt.camera ? 'Có' : 'Không'],
                        ['Báo động trộm', nt.baoDongTrom ? 'Có' : 'Không'],
                        ['PCCC', nt.pccc ? 'Có' : 'Không'],
                        [], // Dòng trống phân biệt
                        ['Danh sách khách thuê']
                    ];
                    const khachThueData = (nt.khachThue || []).map(k => [
                        k.hoTen,
                        k.canCuoc,
                        k.hktt || '',
                        k.noiOHienTai || '',
                        k.soDienThoai || '',
                        k.ngheNghiep || '',
                        k.soPhong,
                        k.loaiXe || '',
                        k.bienSoXe || '',
                        formatDate(k.ngayThue),
                        formatDate(k.ngayTra) || ''
                    ]);
                    const headersKhach = [['Họ tên', 'CCCD', 'HKTT', 'Nơi ở hiện tại', 'SĐT', 'Nghề nghiệp', 'Số phòng', 'Loại xe', 'Biển số xe', 'Ngày thuê', 'Ngày trả']];
                    const fullData = [...infoChung, ...headersKhach, ...khachThueData];
                    const ws = XLSX.utils.aoa_to_sheet(fullData);
                    // Thêm styles cho header
                    ws['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 30 }, { wch: 30 }, { wch: 15 }, { wch: 20 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });
                exportToExcel(wb, `NhaTro_Theo_${cskv}_${new Date().toISOString().split('T')[0]}`);
            };
            if (!isLoggedIn) {
                return <LoginPage onLogin={() => setIsLoggedIn(true)} />;
            }
            return (
                <div className="min-h-screen p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="mb-8 text-center">
                            <h1 className="text-5xl font-bold text-white mb-2">
                                <i className="fas fa-building mr-3"></i>
                                Quản Lý Nhà Trọ
                            </h1>
                            <p className="text-white text-lg opacity-90">Hệ thống quản lý nhà trọ toàn diện - Dành cho Công an cấp xã</p>
                        </div>
                        {view === 'home' && (
                            <HomeView
                                nhaTros={filteredNhaTros}
                                onAdd={() => { setSelectedNhaTro(null); setView('add'); }}
                                onEdit={(nt) => { setSelectedNhaTro(nt); setView('add'); }}
                                onDelete={deleteNhaTro}
                                onDetail={(nt) => { setSelectedNhaTro(nt); setView('detail'); }}
                                searchTerm={searchTerm}
                                setSearchTerm={setSearchTerm}
                                khachDaTra={khachDaTra}
                                onViewKhachDaTra={() => setView('khachDaTra')}
                                onGlobalSearch={() => setView('globalSearch')}
                                onChangePassword={() => setShowChangePassword(true)}
                                onLogout={handleLogout}
                                onBackup={handleBackup}
                                onRestore={handleRestore}
                                onExportByCSKV={exportByCSKV}
                            />
                        )}
                        {view === 'add' && (
                            <AddEditForm
                                nhaTro={selectedNhaTro}
                                onSave={addOrUpdateNhaTro}
                                onCancel={() => setView('home')}
                            />
                        )}
                        {view === 'detail' && (
                            <DetailView
                                nhaTro={selectedNhaTro}
                                onBack={() => setView('home')}
                                onUpdate={async (updated) => {
                                    const newData = nhaTros.map(nt => nt.id === updated.id ? updated : nt);
                                    await saveData(newData);
                                    setSelectedNhaTro(updated);
                                }}
                                onMoveToArchive={async (khach) => {
                                    const khachWithInfo = {
                                        ...khach,
                                        tenNhaTro: selectedNhaTro.tenNhaTro,
                                        diaChiNhaTro: selectedNhaTro.diaChi,
                                        ngayTraPhong: new Date().toISOString().split('T')[0]
                                    };
                                    const updatedKhachDaTra = [...khachDaTra, khachWithInfo];
                                    await saveKhachDaTra(updatedKhachDaTra);
                                }}
                                khachDaTra={khachDaTra}
                            />
                        )}
                        {view === 'khachDaTra' && (
                            <KhachDaTraView
                                khachDaTra={khachDaTra}
                                onBack={() => setView('home')}
                                onDelete={async (id) => {
                                    const updated = khachDaTra.filter(k => k.id !== id);
                                    await saveKhachDaTra(updated);
                                }}
                            />
                        )}
                        {view === 'globalSearch' && (
                            <GlobalSearchView
                                nhaTros={nhaTros}
                                khachDaTra={khachDaTra}
                                onBack={() => setView('home')}
                            />
                        )}
                    </div>
                    {showChangePassword && (
                        <ChangePasswordModal
                            onClose={() => setShowChangePassword(false)}
                            onSave={handleChangePassword}
                        />
                    )}
                </div>
            );
        }
        // Component LoginPage
        function LoginPage({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const handleLogin = async (e) => {
                e.preventDefault();
                await dbManager.init();
                const settings = await dbManager.get('settings', 'credentials');
                const credentials = settings?.value || {
                    username: 'admin',
                    password: 'admin'
                };
                if (username === credentials.username && password === credentials.password) {
                    onLogin();
                } else {
                    alert('Tên đăng nhập hoặc mật khẩu không đúng!');
                }
            };
            return (
                <div className="min-h-screen flex items-center justify-center">
                <div className="card p-8 w-96">
                        <h2 className="text-2xl font-bold mb-6 text-center">Đăng nhập</h2>
                        <form onSubmit={handleLogin}>
                            <div className="mb-4">
                                <label className="block text-sm font-semibold mb-2">Tên đăng nhập</label>
                                <input
                                    type="text"
                                    className="input-field"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    required
                                />
                            </div>
                            <div className="mb-6">
                                <label className="block text-sm font-semibold mb-2">Mật khẩu</label>
                                <input
                                    type="password"
                                    className="input-field"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>
                            <button type="submit" className="btn btn-primary w-full">
                                <i className="fas fa-sign-in-alt mr-2"></i>Đăng nhập
                            </button>
                        </form>
                    </div>
                </div>
            );
        }
        // Component ChangePasswordModal
        function ChangePasswordModal({ onClose, onSave }) {
            const [newUsername, setNewUsername] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if (newPassword !== confirmPassword) {
                    alert('Mật khẩu xác nhận không khớp!');
                    return;
                }
                onSave({ username: newUsername, password: newPassword });
            };
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-2xl font-bold mb-6">Đổi mật khẩu</h3>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-semibold mb-2">Tên đăng nhập mới</label>
                                <input
                                    type="text"
                                    className="input-field"
                                    value={newUsername}
                                    onChange={(e) => setNewUsername(e.target.value)}
                                    required
                                />
                            </div>
                            <div className="mb-4">
                                <label className="block text-sm font-semibold mb-2">Mật khẩu mới</label>
                                <input
                                    type="password"
                                    className="input-field"
                                    value={newPassword}
                                    onChange={(e) => setNewPassword(e.target.value)}
                                    required
                                />
                            </div>
                            <div className="mb-6">
                                <label className="block text-sm font-semibold mb-2">Xác nhận mật khẩu</label>
                                <input
                                    type="password"
                                    className="input-field"
                                    value={confirmPassword}
                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                    required
                                />
                            </div>
                            <div className="flex gap-4 justify-end">
                                <button type="button" className="btn btn-danger" onClick={onClose}>
                                    <i className="fas fa-times mr-2"></i>Hủy
                                </button>
                                <button type="submit" className="btn btn-primary">
                                    <i className="fas fa-save mr-2"></i>Lưu
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
        // Component Trang chủ
        function HomeView({ nhaTros, onAdd, onEdit, onDelete, onDetail, searchTerm, setSearchTerm, khachDaTra, onViewKhachDaTra, onGlobalSearch, onChangePassword, onLogout, onBackup, onRestore, onExportByCSKV }) {
            const tongSoPhong = nhaTros.reduce((sum, nt) => sum + parseInt(nt.soPhong || 0), 0);
            const tongKhachThue = nhaTros.reduce((sum, nt) => sum + (nt.khachThue?.length || 0), 0);
            const tyLeDay = tongSoPhong > 0 ? ((tongKhachThue / tongSoPhong) * 100).toFixed(1) : 0;
            const uniqueCSKV = [...new Set(nhaTros.map(nt => nt.cskv).filter(Boolean))].sort();
            return (
                <div>
                    <div className="flex justify-end mb-4 gap-2">
                        <button className="btn btn-warning" onClick={onChangePassword}>
                            <i className="fas fa-key mr-2"></i>
                            Đổi mật khẩu
                        </button>
                        <button className="btn btn-info" onClick={onBackup}>
                            <i className="fas fa-download mr-2"></i>
                            Backup
                        </button>
                        <label className="btn btn-success cursor-pointer">
                            <i className="fas fa-upload mr-2"></i>
                            Restore
                            <input type="file" accept=".json" onChange={onRestore} className="hidden" />
                        </label>
                        <button className="btn btn-danger" onClick={onLogout}>
                            <i className="fas fa-sign-out-alt mr-2"></i>
                            Đăng xuất
                        </button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div className="stats-card">
                            <i className="fas fa-home text-4xl mb-2"></i>
                            <div className="text-3xl font-bold">{nhaTros.length}</div>
                            <div className="text-sm opacity-90">Nhà trọ</div>
                        </div>
                        <div className="stats-card">
                            <i className="fas fa-door-open text-4xl mb-2"></i>
                            <div className="text-3xl font-bold">{tongSoPhong}</div>
                            <div className="text-sm opacity-90">Tổng phòng</div>
                        </div>
                        <div className="stats-card">
                            <i className="fas fa-users text-4xl mb-2"></i>
                            <div className="text-3xl font-bold">{tongKhachThue}</div>
                            <div className="text-sm opacity-90">Khách thuê</div>
                        </div>
                        <div className="stats-card">
                            <i className="fas fa-chart-line text-4xl mb-2"></i>
                            <div className="text-3xl font-bold">{tyLeDay}%</div>
                            <div className="text-sm opacity-90">Tỷ lệ lấp đầy</div>
                        </div>
                    </div>
                    <div className="card p-6 mb-6">
                        <div className="flex flex-col md:flex-row gap-4 justify-between items-center">
                            <div className="flex-1 w-full md:w-auto">
                                <div className="relative">
                                    <i className="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input
                                        type="text"
                                        placeholder="Tìm kiếm tên, địa chỉ, CSKV..."
                                        className="input-field pl-12"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                            </div>
                            <div className="flex gap-3 flex-wrap">
                                <button className="btn btn-info" onClick={onGlobalSearch}>
                                    <i className="fas fa-search-plus mr-2"></i>
                                    Tìm kiếm toàn cục
                                </button>
                                <button className="btn btn-warning" onClick={onViewKhachDaTra}>
                                    <i className="fas fa-history mr-2"></i>
                                    Khách đã trả ({khachDaTra.length})
                                </button>
                                <button className="btn btn-primary" onClick={onAdd}>
                                    <i className="fas fa-plus mr-2"></i>
                                    Thêm nhà trọ
                                </button>
                                <select className="btn btn-info" onChange={(e) => { if (e.target.value) onExportByCSKV(e.target.value); e.target.value = ''; }}>
                                    <option value="">Xuất theo CSKV</option>
                                    {uniqueCSKV.map(c => (
                                     <option key={c} value={c} style={{color: 'orange'}}>{c}</option>
                                ))}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {nhaTros.length === 0 ? (
                            <div className="col-span-full text-center py-12 card">
                                <i className="fas fa-building text-6xl text-gray-300 mb-4"></i>
                                <p className="text-gray-500 text-lg">Chưa có nhà trọ nào. Hãy thêm mới!</p>
                            </div>
                        ) : (
                            nhaTros.map(nt => (
                                <div key={nt.id} className="card p-6">
                                    <div className="flex justify-between items-start mb-4">
                                        <h3 className="text-xl font-bold text-gray-800 flex-1">{nt.tenNhaTro}</h3>
                                        <span className={`badge ${nt.khachThue?.length > 0 ? 'badge-success' : 'badge-warning'}`}>
                                            {nt.khachThue?.length || 0} khách
                                        </span>
                                    </div>
                                 
                                    <div className="space-y-2 mb-4 text-sm text-gray-600">
                                        <div className="flex items-center">
                                            <i className="fas fa-map-marker-alt w-5 text-purple-600"></i>
                                            <span>{nt.diaChi}</span>
                                        </div>
                                        <div className="flex items-center">
                                            <i className="fas fa-door-open w-5 text-blue-600"></i>
                                            <span>{nt.soPhong} phòng</span>
                                        </div>
                                        <div className="flex items-center">
                                            <i className="fas fa-user w-5 text-green-600"></i>
                                            <span>QL: {nt.nguoiQuanLy?.hoTen || 'Chưa có'}</span>
                                        </div>
                                        <div className="flex items-center">
                                            <i className="fas fa-shield-alt w-5 text-red-600"></i>
                                            <span>CSKV: {nt.cskv || 'Chưa có'}</span>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 pt-4 border-t">
                                        <button className="btn btn-primary flex-1 text-sm" onClick={() => onDetail(nt)}>
                                            <i className="fas fa-eye mr-1"></i> Chi tiết
                                        </button>
                                        <button className="btn btn-success text-sm" onClick={() => onEdit(nt)}>
                                            <i className="fas fa-edit"></i>
                                        </button>
                                        <button className="btn btn-danger text-sm" onClick={() => onDelete(nt.id)}>
                                            <i className="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        }
        // Component Form thêm/sửa nhà trọ
        function AddEditForm({ nhaTro, onSave, onCancel }) {
            const [formData, setFormData] = useState(nhaTro || {
                tenNhaTro: '',
                diaChi: '',
                soPhong: '',
                camera: false,
                baoDongTrom: false,
                pccc: false,
                cameraNote: '',
                baoDongNote: '',
                pcccNote: '',
                chuNha: { hoTen: '', canCuoc: '', hktt: '', noiOHienTai: '', soDienThoai: '' },
                nguoiThue: { hoTen: '', canCuoc: '', hktt: '', noiOHienTai: '', soDienThoai: '' },
                nguoiQuanLy: { hoTen: '', canCuoc: '', hktt: '', noiOHienTai: '', soDienThoai: '' },
                chuNhaIsNguoiThue: false,
                chuNhaIsNguoiQuanLy: false,
                anhNhaTro: [],
                cskv: ''
            });
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.tenNhaTro || !formData.diaChi || !formData.soPhong) {
                    alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
                    return;
                }
                const dataToSave = { ...formData };
                if (dataToSave.chuNhaIsNguoiThue) {
                    dataToSave.nguoiThue = { ...dataToSave.chuNha };
                }
                if (dataToSave.chuNhaIsNguoiQuanLy) {
                    dataToSave.nguoiQuanLy = { ...dataToSave.chuNha };
                }
                onSave(dataToSave);
            };
            const updateField = (section, field, value) => {
                setFormData(prev => ({
                    ...prev,
                    [section]: { ...prev[section], [field]: value }
                }));
            };
            const handleImageUpload = (e, index) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const newAnhNhaTro = [...formData.anhNhaTro];
                        newAnhNhaTro[index] = reader.result;
                        setFormData({ ...formData, anhNhaTro: newAnhNhaTro });
                    };
                    reader.readAsDataURL(file);
                }
            };
            const deleteImage = (index) => {
                const newAnhNhaTro = [...formData.anhNhaTro];
                newAnhNhaTro[index] = null;
                setFormData({ ...formData, anhNhaTro: newAnhNhaTro });
            };
            return (
                <div className="card p-8">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-gray-800">
                            <i className={`fas fa-${nhaTro ? 'edit' : 'plus-circle'} mr-3 text-purple-600`}></i>
                            {nhaTro ? 'Chỉnh sửa nhà trọ' : 'Thêm nhà trọ mới'}
                        </h2>
                    </div>
                    <form onSubmit={handleSubmit}>
                        <div className="mb-8">
                            <h3 className="text-xl font-bold mb-4 pb-2 border-b-2 border-purple-200">
                                <i className="fas fa-building text-purple-600 mr-2"></i>
                                Thông tin nhà trọ
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-semibold mb-2 text-gray-700">
                                        Tên nhà trọ <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        className="input-field"
                                        value={formData.tenNhaTro}
                                        onChange={(e) => setFormData({...formData, tenNhaTro: e.target.value})}
                                        placeholder="VD: Nhà trọ Hòa Bình"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold mb-2 text-gray-700">
                                        Số phòng cho thuê <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="number"
                                        className="input-field"
                                        value={formData.soPhong}
                                        onChange={(e) => setFormData({...formData, soPhong: e.target.value})}
                                        placeholder="VD: 10"
                                        required
                                    />
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-semibold mb-2 text-gray-700">
                                        Địa chỉ <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        className="input-field"
                                        value={formData.diaChi}
                                        onChange={(e) => setFormData({...formData, diaChi: e.target.value})}
                                        placeholder="VD: 123 Đường ABC, Quận 1, TP.HCM"
                                        required
                                    />
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-semibold mb-2 text-gray-700">
                                        Cảnh sát khu vực (CSKV)
                                    </label>
                                    <input
                                        type="text"
                                        className="input-field"
                                        value={formData.cskv}
                                        onChange={(e) => setFormData({...formData, cskv: e.target.value})}
                                        placeholder="VD: Nguyễn Văn A"
                                    />
                                </div>
                            </div>
                            <div className="md:col-span-2 mt-4">
                                <label className="block text-sm font-semibold mb-3 text-gray-700">Hình ảnh nhà trọ (tối đa 2 ảnh)</label>
                                <div className="photo-grid">
                                    {[...Array(2)].map((_, index) => (
                                        <div key={index}>
                                            <input
                                                type="file"
                                                accept="image/*"
                                                onChange={(e) => handleImageUpload(e, index)}
                                                className="hidden"
                                                id={`photo-${index}`}
                                            />
                                            <label htmlFor={`photo-${index}`} className="photo-grid-item">
                                                {formData.anhNhaTro?.[index] ? (
                                                    <>
                                                        <img src={formData.anhNhaTro[index]} />
                                                        <button type="button" onClick={() => deleteImage(index)}>
                                                            <i className="fas fa-times"></i>
                                                        </button>
                                                    </>
                                                ) : (
                                                    <div className="text-center text-gray-400">
                                                        <i className="fas fa-camera text-3xl mb-2"></i>
                                                        <div className="text-xs">Thêm ảnh</div>
                                                    </div>
                                                )}
                                            </label>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="md:col-span-2 mt-4">
                                <label className="block text-sm font-semibold mb-3 text-gray-700">Tiện ích</label>
                                <div className="flex flex-wrap gap-4">
                                    <div className="p-3 border rounded-lg">
                                        <label className="flex items-center cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={formData.camera}
                                                onChange={(e) => setFormData({...formData, camera: e.target.checked})}
                                                className="w-5 h-5 text-purple-600 rounded"
                                            />
                                            <span className="ml-2"><i className="fas fa-video mr-1 text-purple-600"></i>Camera</span>
                                        </label>
                                        {formData.camera && (
                                            <textarea
                                                className="input-field mt-2"
                                                rows="3"
                                                placeholder="Số lượng, loại, thời gian lưu, vị trí, tài khoản..."
                                                value={formData.cameraNote}
                                                onChange={(e) => setFormData({...formData, cameraNote: e.target.value})}
                                            />
                                        )}
                                    </div>
                                    <div className="p-3 border rounded-lg">
                                        <label className="flex items-center cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={formData.baoDongTrom}
                                                onChange={(e) => setFormData({...formData, baoDongTrom: e.target.checked})}
                                                className="w-5 h-5 text-purple-600 rounded"
                                            />
                                            <span className="ml-2"><i className="fas fa-bell mr-1 text-red-600"></i>Báo động trộm</span>
                                        </label>
                                        {formData.baoDongTrom && (
                                            <textarea
                                                className="input-field mt-2"
                                                rows="3"
                                                placeholder="Số lượng, loại, vị trí..."
                                                value={formData.baoDongNote}
                                                onChange={(e) => setFormData({...formData, baoDongNote: e.target.value})}
                                            />
                                        )}
                                    </div>
                                    <div className="p-3 border rounded-lg">
                                        <label className="flex items-center cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={formData.pccc}
                                                onChange={(e) => setFormData({...formData, pccc: e.target.checked})}
                                                className="w-5 h-5 text-purple-600 rounded"
                                            />
                                            <span className="ml-2"><i className="fas fa-fire-extinguisher mr-1 text-orange-600"></i>PCCC</span>
                                        </label>
                                        {formData.pccc && (
                                            <textarea
                                                className="input-field mt-2"
                                                rows="3"
                                                placeholder="Số lượng, loại, vị trí..."
                                                value={formData.pcccNote}
                                                onChange={(e) => setFormData({...formData, pcccNote: e.target.value})}
                                            />
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <PersonForm
                            title="Thông tin chủ nhà"
                            icon="user-tie"
                            color="blue"
                            data={formData.chuNha}
                            onChange={(field, value) => updateField('chuNha', field, value)}
                        />
                        <div className="flex gap-4 mb-4">
                            <label className="flex items-center cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={formData.chuNhaIsNguoiThue}
                                    onChange={(e) => setFormData({...formData, chuNhaIsNguoiThue: e.target.checked})}
                                    className="w-5 h-5 text-purple-600 rounded"
                                />
                                <span className="ml-2">Chủ nhà là người thuê</span>
                            </label>
                            <label className="flex items-center cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={formData.chuNhaIsNguoiQuanLy}
                                    onChange={(e) => setFormData({...formData, chuNhaIsNguoiQuanLy: e.target.checked})}
                                    className="w-5 h-5 text-purple-600 rounded"
                                />
                                <span className="ml-2">Chủ nhà là người quản lý</span>
                            </label>
                        </div>
                        {!formData.chuNhaIsNguoiThue && (
                            <PersonForm
                                title="Thông tin người thuê (Bạn)"
                                icon="user"
                                color="green"
                                data={formData.nguoiThue}
                                onChange={(field, value) => updateField('nguoiThue', field, value)}
                            />
                        )}
                        {!formData.chuNhaIsNguoiQuanLy && (
                            <PersonForm
                                title="Thông tin người quản lý"
                                icon="user-cog"
                                color="orange"
                                data={formData.nguoiQuanLy}
                                onChange={(field, value) => updateField('nguoiQuanLy', field, value)}
                            />
                        )}
                        <div className="flex gap-4 justify-end pt-6 border-t">
                            <button type="button" className="btn btn-danger" onClick={onCancel}>
                                <i className="fas fa-times mr-2"></i>
                                Hủy bỏ
                            </button>
                            <button type="submit" className="btn btn-primary">
                                <i className="fas fa-save mr-2"></i>
                                {nhaTro ? 'Cập nhật' : 'Lưu lại'}
                            </button>
                        </div>
                    </form>
                </div>
            );
        }
        function PersonForm({ title, icon, color, data, onChange }) {
            return (
                <div className="mb-8">
                    <h3 className="text-xl font-bold mb-4 pb-2 border-b-2" style={{borderColor: `var(--${color}-200)`}}>
                        <i className={`fas fa-${icon} mr-2`} style={{color: `var(--${color}-600)`}}></i>
                        {title}
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-semibold mb-2 text-gray-700">Họ tên</label>
                            <input
                                type="text"
                                className="input-field"
                                value={data.hoTen}
                                onChange={(e) => onChange('hoTen', e.target.value)}
                                placeholder="VD: Nguyễn Văn A"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-semibold mb-2 text-gray-700">Số CCCD</label>
                            <input
                                type="text"
                                className="input-field"
                                value={data.canCuoc}
                                onChange={(e) => onChange('canCuoc', e.target.value)}
                                placeholder="VD: 001234567890"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-semibold mb-2 text-gray-700">HKTT</label>
                            <input
                                type="text"
                                className="input-field"
                                value={data.hktt}
                                onChange={(e) => onChange('hktt', e.target.value)}
                                placeholder="VD: 123 Đường XYZ, Quận 1"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-semibold mb-2 text-gray-700">Nơi ở hiện tại</label>
                            <input
                                type="text"
                                className="input-field"
                                value={data.noiOHienTai}
                                onChange={(e) => onChange('noiOHienTai', e.target.value)}
                                placeholder="VD: 456 Đường ABC, Quận 2"
                            />
                        </div>
                        <div className="md:col-span-2">
                            <label className="block text-sm font-semibold mb-2 text-gray-700">Số điện thoại</label>
                            <input
                                type="tel"
                                className="input-field"
                                value={data.soDienThoai}
                                onChange={(e) => onChange('soDienThoai', e.target.value)}
                                placeholder="VD: 0901234567"
                            />
                        </div>
                    </div>
                </div>
            );
        }
        // Component Chi tiết nhà trọ
        function DetailView({ nhaTro, onBack, onUpdate, onMoveToArchive, khachDaTra }) {
            const [activeTab, setActiveTab] = useState('info');
            const tabs = [
                { id: 'info', label: 'Thông tin', icon: 'info-circle' },
                { id: 'tenants', label: 'Khách thuê', icon: 'users', badge: nhaTro.khachThue?.length || 0 }
            ];
            const handleExportReport = () => {
                const wb = XLSX.utils.book_new();
                // Sheet 1: Thông tin chung nhà trọ
                const sheet1Data = [
                    ['Thông tin chung nhà trọ'],
                    ['Tên nhà trọ', nhaTro.tenNhaTro],
                    ['Địa chỉ', nhaTro.diaChi],
                    ['Số phòng', nhaTro.soPhong],
                    ['CSKV', nhaTro.cskv || ''],
                    ['Camera', nhaTro.camera ? 'Có' : 'Không'],
                    ['Ghi chú Camera', nhaTro.cameraNote || ''],
                    ['Báo động trộm', nhaTro.baoDongTrom ? 'Có' : 'Không'],
                    ['Ghi chú Báo động trộm', nhaTro.baoDongNote || ''],
                    ['PCCC', nhaTro.pccc ? 'Có' : 'Không'],
                    ['Ghi chú PCCC', nhaTro.pcccNote || ''],
                    ['Chủ nhà - Họ tên', nhaTro.chuNha?.hoTen || ''],
                    ['Chủ nhà - CCCD', nhaTro.chuNha?.canCuoc || ''],
                    ['Chủ nhà - HKTT', nhaTro.chuNha?.hktt || ''],
                    ['Chủ nhà - Nơi ở hiện tại', nhaTro.chuNha?.noiOHienTai || ''],
                    ['Chủ nhà - SĐT', nhaTro.chuNha?.soDienThoai || ''],
                    ['Người thuê - Họ tên', nhaTro.nguoiThue?.hoTen || ''],
                    ['Người thuê - CCCD', nhaTro.nguoiThue?.canCuoc || ''],
                    ['Người thuê - HKTT', nhaTro.nguoiThue?.hktt || ''],
                    ['Người thuê - Nơi ở hiện tại', nhaTro.nguoiThue?.noiOHienTai || ''],
                    ['Người thuê - SĐT', nhaTro.nguoiThue?.soDienThoai || ''],
                    ['Người quản lý - Họ tên', nhaTro.nguoiQuanLy?.hoTen || ''],
                    ['Người quản lý - CCCD', nhaTro.nguoiQuanLy?.canCuoc || ''],
                    ['Người quản lý - HKTT', nhaTro.nguoiQuanLy?.hktt || ''],
                    ['Người quản lý - Nơi ở hiện tại', nhaTro.nguoiQuanLy?.noiOHienTai || ''],
                    ['Người quản lý - SĐT', nhaTro.nguoiQuanLy?.soDienThoai || '']
                ];
                const ws1 = XLSX.utils.aoa_to_sheet(sheet1Data);
                ws1['!cols'] = [{ wch: 30 }, { wch: 50 }];
                XLSX.utils.book_append_sheet(wb, ws1, "ThongTinChung");
                // Sheet 2: Khách thuê
                const sheet2Data = [['Họ tên', 'CCCD', 'HKTT', 'Nơi ở hiện tại', 'SĐT', 'Nghề nghiệp', 'Số phòng', 'Loại xe', 'Biển số xe', 'Ngày thuê', 'Ngày trả', 'Địa chỉ nhà trọ']];
                const khachThueData = (nhaTro.khachThue || []).map(k => [
                    k.hoTen,
                    k.canCuoc,
                    k.hktt || '',
                    k.noiOHienTai || '',
                    k.soDienThoai || '',
                    k.ngheNghiep || '',
                    k.soPhong,
                    k.loaiXe || '',
                    k.bienSoXe || '',
                    formatDate(k.ngayThue),
                    formatDate(k.ngayTra),
                    nhaTro.diaChi
                ]);
                const fullSheet2 = [...sheet2Data, ...khachThueData];
                const ws2 = XLSX.utils.aoa_to_sheet(fullSheet2);
                ws2['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 30 }, { wch: 30 }, { wch: 15 }, { wch: 20 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 30 }];
                XLSX.utils.book_append_sheet(wb, ws2, "KhachThue");
                exportToExcel(wb, `BaoCao_${nhaTro.tenNhaTro}_${new Date().toISOString().split('T')[0]}`);
            };
            return (
                <div className="card p-8">
                    <div className="flex justify-between items-center mb-6 pb-4 border-b">
                        <div>
                            <h2 className="text-3xl font-bold text-gray-800">{nhaTro.tenNhaTro}</h2>
                            <p className="text-gray-600 mt-1">
                                <i className="fas fa-map-marker-alt mr-2"></i>{nhaTro.diaChi}
                            </p>
                        </div>
                        <div className="flex gap-2">
                            <button className="btn btn-success" onClick={handleExportReport}>
                                <i className="fas fa-file-excel mr-2"></i>
                                Xuất báo cáo
                            </button>
                            <button className="btn btn-danger" onClick={onBack}>
                                <i className="fas fa-arrow-left mr-2"></i>
                                Quay lại
                            </button>
                        </div>
                    </div>
                    <div className="flex border-b mb-6">
                        {tabs.map(tab => (
                            <div
                                key={tab.id}
                                className={`tab ${activeTab === tab.id ? 'active' : ''}`}
                                onClick={() => setActiveTab(tab.id)}
                            >
                                <i className={`fas fa-${tab.icon} mr-2`}></i>
                                {tab.label}
                                {tab.badge !== undefined && (
                                    <span className="ml-2 badge badge-success">{tab.badge}</span>
                                )}
                            </div>
                        ))}
                    </div>
                    {activeTab === 'info' && (
                        <InfoTab nhaTro={nhaTro} />
                    )}
                    {activeTab === 'tenants' && (
                        <TenantsTab
                            nhaTro={nhaTro}
                            onUpdate={onUpdate}
                            onMoveToArchive={onMoveToArchive}
                        />
                    )}
                </div>
            );
        }
        function InfoTab({ nhaTro }) {
            return (
                <div className="space-y-6">
                    {nhaTro.anhNhaTro && nhaTro.anhNhaTro.filter(Boolean).length > 0 && (
                        <div className="border rounded-lg p-5 bg-gray-50">
                            <h4 className="text-lg font-bold mb-4" style={{color: `var(--purple-600)`}}>
                                <i className="fas fa-images mr-2"></i>
                                Hình ảnh nhà trọ
                            </h4>
                            <div className="photo-grid">
                                {nhaTro.anhNhaTro.filter(Boolean).map((img, idx) => (
                                    <div key={idx} className="photo-grid-item">
                                        <img src={img} alt={`Ảnh ${idx + 1}`} />
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    <InfoSection
                        title="Thông tin nhà trọ"
                        icon="building"
                        color="purple"
                        data={[
                            { label: 'Tên nhà trọ', value: nhaTro.tenNhaTro },
                            { label: 'Địa chỉ', value: nhaTro.diaChi },
                            { label: 'Số phòng', value: nhaTro.soPhong },
                            { label: 'CSKV', value: nhaTro.cskv || 'Chưa có' },
                            {
                                label: 'Tiện ích',
                                value: [
                                    nhaTro.camera && '📹 Camera',
                                    nhaTro.baoDongTrom && '🔔 Báo động',
                                    nhaTro.pccc && '🧯 PCCC'
                                ].filter(Boolean).join(', ') || 'Không có'
                            }
                        ]}
                    />
                    <div className="border rounded-lg p-5 bg-gray-50">
                        <h4 className="text-lg font-bold mb-4" style={{color: `var(--purple-600)`}}>
                            <i className="fas fa-tools mr-2"></i>
                            Ghi chú tiện ích
                        </h4>
                        <div className="space-y-4">
                            {nhaTro.camera && (
                                <div className="p-3 bg-white border-l-4 border-purple-500 rounded">
                                    <div className="font-semibold">
                                        <i className="fas fa-video mr-2 text-purple-600"></i>
                                        Camera an ninh
                                    </div>
                                    {nhaTro.cameraNote && (
                                        <div className="text-sm whitespace-pre-wrap mt-1">
                                            {nhaTro.cameraNote}
                                        </div>
                                    )}
                                </div>
                            )}
                            {nhaTro.baoDongTrom && (
                                <div className="p-3 bg-white border-l-4 border-red-500 rounded">
                                    <div className="font-semibold">
                                        <i className="fas fa-bell mr-2 text-red-600"></i>
                                        Báo động trộm
                                    </div>
                                    {nhaTro.baoDongNote && (
                                        <div className="text-sm whitespace-pre-wrap mt-1">
                                            {nhaTro.baoDongNote}
                                        </div>
                                    )}
                                </div>
                            )}
                            {nhaTro.pccc && (
                                <div className="p-3 bg-white border-l-4 border-orange-500 rounded">
                                    <div className="font-semibold">
                                        <i className="fas fa-fire-extinguisher mr-2 text-orange-600"></i>
                                        PCCC
                                    </div>
                                    {nhaTro.pcccNote && (
                                        <div className="text-sm whitespace-pre-wrap mt-1">
                                            {nhaTro.pcccNote}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                    <InfoSection
                        title="Chủ nhà"
                        icon="user-tie"
                        color="blue"
                        data={[
                            { label: 'Họ tên', value: nhaTro.chuNha?.hoTen },
                            { label: 'CCCD', value: nhaTro.chuNha?.canCuoc },
                            { label: 'HKTT', value: nhaTro.chuNha?.hktt },
                            { label: 'Nơi ở hiện tại', value: nhaTro.chuNha?.noiOHienTai },
                            { label: 'Số điện thoại', value: nhaTro.chuNha?.soDienThoai }
                        ]}
                    />
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <InfoSection
                            title="Người thuê"
                            icon="user"
                            color="green"
                            data={[
                                { label: 'Họ tên', value: nhaTro.nguoiThue?.hoTen },
                                { label: 'CCCD', value: nhaTro.nguoiThue?.canCuoc },
                                { label: 'HKTT', value: nhaTro.nguoiThue?.hktt },
                                { label: 'Nơi ở hiện tại', value: nhaTro.nguoiThue?.noiOHienTai },
                                { label: 'Số điện thoại', value: nhaTro.nguoiThue?.soDienThoai }
                            ]}
                        />
                        <InfoSection
                            title="Người quản lý"
                            icon="user-cog"
                            color="orange"
                            data={[
                                { label: 'Họ tên', value: nhaTro.nguoiQuanLy?.hoTen },
                                { label: 'CCCD', value: nhaTro.nguoiQuanLy?.canCuoc },
                                { label: 'HKTT', value: nhaTro.nguoiQuanLy?.hktt },
                                { label: 'Nơi ở hiện tại', value: nhaTro.nguoiQuanLy?.noiOHienTai },
                                { label: 'Số điện thoại', value: nhaTro.nguoiQuanLy?.soDienThoai }
                            ]}
                        />
                    </div>
                </div>
            );
        }
        function InfoSection({ title, icon, color, data }) {
            return (
                <div className="border rounded-lg p-5 bg-gray-50">
                    <h4 className="text-lg font-bold mb-4" style={{color: `var(--${color}-600)`}}>
                        <i className={`fas fa-${icon} mr-2`}></i>
                        {title}
                    </h4>
                    <div className="space-y-2">
                        {data.map((item, idx) => (
                            <div key={idx} className="flex">
                                <span className="font-semibold text-gray-700 w-40">{item.label}:</span>
                                <span className="text-gray-600 flex-1">{item.value || 'Chưa có thông tin'}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        // Tab khách thuê với quản lý theo phòng
        function TenantsTab({ nhaTro, onUpdate, onMoveToArchive }) {
            const [showAddTenant, setShowAddTenant] = useState(false);
            const [editingTenant, setEditingTenant] = useState(null);
            const [filterRoom, setFilterRoom] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedRoom, setSelectedRoom] = useState(null);
            const addOrUpdateTenant = (tenant) => {
                let updated;
                if (tenant.originalId) {
                    updated = {
                        ...nhaTro,
                        khachThue: nhaTro.khachThue.map(t =>
                            t.id === tenant.originalId ? { ...tenant, id: tenant.originalId } : t
                        )
                    };
                } else {
                    updated = {
                        ...nhaTro,
                        khachThue: [...(nhaTro.khachThue || []), { ...tenant, id: Date.now() }]
                    };
                }
                onUpdate(updated);
                setShowAddTenant(false);
                setEditingTenant(null);
            };
            const deleteTenant = (tenantId, moveToArchive = false) => {
                const tenant = nhaTro.khachThue.find(t => t.id === tenantId);
                if (moveToArchive && tenant) {
                    onMoveToArchive(tenant);
                }
                const updated = {
                    ...nhaTro,
                    khachThue: nhaTro.khachThue.filter(t => t.id !== tenantId)
                };
                onUpdate(updated);
            };
            const exportAllTenants = () => {
                if (!nhaTro.khachThue || nhaTro.khachThue.length === 0) {
                    alert('⚠️ Chưa có khách thuê nào để xuất!');
                    return;
                }
             
                const data = (nhaTro.khachThue || []).map(k => ({
                    'Họ tên': k.hoTen,
                    'Số CCCD': k.canCuoc,
                    'HKTT': k.hktt,
                    'Nơi ở hiện tại': k.noiOHienTai,
                    'Số điện thoại': k.soDienThoai,
                    'Nghề nghiệp': k.ngheNghiep,
                    'Số phòng': k.soPhong,
                    'Loại xe': k.loaiXe,
                    'Biển số xe': k.bienSoXe,
                    'Ngày thuê': formatDate(k.ngayThue),
                    'Ngày trả': formatDate(k.ngayTra),
                    'Địa chỉ nhà trọ': nhaTro.diaChi
                }));
             
                exportToExcel(data, `TatCaKhach_${nhaTro.tenNhaTro}_${new Date().toISOString().split('T')[0]}`);
                alert('✅ Đã xuất tất cả khách ra Excel thành công!');
            };
            const tenantsByRoom = {};
            (nhaTro.khachThue || []).forEach(tenant => {
                const room = tenant.soPhong || 'Chưa xác định';
                if (!tenantsByRoom[room]) {
                    tenantsByRoom[room] = [];
                }
                tenantsByRoom[room].push(tenant);
            });
            let filteredRooms = Object.keys(tenantsByRoom).sort((a, b) => {
                if (a === 'Chưa xác định') return 1;
                if (b === 'Chưa xác định') return -1;
                return a.localeCompare(b, 'vi', { numeric: true });
            });
            if (filterRoom !== 'all') {
                filteredRooms = filteredRooms.filter(room => room === filterRoom);
            }
            if (searchTerm) {
                filteredRooms = filteredRooms.filter(room => {
                    return tenantsByRoom[room].some(tenant =>
                        tenant.hoTen?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        tenant.canCuoc?.includes(searchTerm) ||
                        tenant.bienSoXe?.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                });
            }
            const uniqueRooms = [...new Set((nhaTro.khachThue || []).map(t => t.soPhong))].sort((a, b) =>
                a.localeCompare(b, 'vi', { numeric: true })
            );
            if (selectedRoom) {
                const roomTenants = tenantsByRoom[selectedRoom] || [];
                return (
                    <div>
                        <button className="btn btn-danger mb-4" onClick={() => setSelectedRoom(null)}>
                            <i className="fas fa-arrow-left mr-2"></i>
                            Quay lại danh sách phòng
                        </button>
                        <div className="room-group">
                            <div className="room-group-header">
                                <div>
                                    <i className="fas fa-door-open mr-2"></i>
                                    Phòng {selectedRoom}
                                </div>
                                <span className="badge badge-info">
                                    {roomTenants.length} người
                                </span>
                            </div>
                            <div className="space-y-2">
                                {roomTenants.map(tenant => (
                                    <TenantItem
                                        key={tenant.id}
                                        tenant={tenant}
                                        onEdit={() => {
                                            setEditingTenant(tenant);
                                            setShowAddTenant(true);
                                        }}
                                        onDelete={deleteTenant}
                                        diaChiNhaTro={nhaTro.diaChi}
                                    />
                                ))}
                            </div>
                        </div>
                        {showAddTenant && (
                            <TenantForm
                                tenant={editingTenant}
                                onSave={addOrUpdateTenant}
                                onCancel={() => {
                                    setShowAddTenant(false);
                                    setEditingTenant(null);
                                }}
                                defaultAddress={nhaTro.diaChi}
                            />
                        )}
                    </div>
                );
            }
            return (
                <div>
                    <div className="grid grid-cols-3 gap-4 mb-6">
                        <div className="bg-green-50 p-4 rounded-lg border-2 border-green-200">
                            <div className="text-2xl font-bold text-green-600">{nhaTro.khachThue?.length || 0}</div>
                            <div className="text-sm text-gray-600">Tổng khách thuê</div>
                        </div>
                        <div className="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
                            <div className="text-2xl font-bold text-blue-600">{Object.keys(tenantsByRoom).length}</div>
                            <div className="text-sm text-gray-600">Số phòng đang thuê</div>
                        </div>
                        <div className="bg-purple-50 p-4 rounded-lg border-2 border-purple-200">
                            <div className="text-2xl font-bold text-purple-600">
                                {Math.max(...Object.values(tenantsByRoom).map(arr => arr.length), 0)}
                            </div>
                            <div className="text-sm text-gray-600">Người/phòng (tối đa)</div>
                        </div>
                    </div>
                    <div className="card p-4 mb-6">
                        <div className="flex flex-col md:flex-row gap-3 items-end">
                            <div className="flex-1 min-w-0">
                                <label className="block text-xs">Tìm kiếm</label>
                                <input
                                    type="text"
                                    placeholder="Tên, CCCD, biển số..."
                                    className="input-field text-sm py-2"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <div className="w-full md:w-48">
                                <label className="block text-xs">Lọc phòng</label>
                                <select
                                    className="input-field text-sm py-2"
                                    value={filterRoom}
                                    onChange={(e) => setFilterRoom(e.target.value)}
                                >
                                    <option value="all">Tất cả phòng</option>
                                    {uniqueRooms.map(room => (
                                        <option key={room} value={room}>Phòng {room}</option>
                                    ))}
                                </select>
                            </div>
                            <button
                                className="btn btn-primary text-sm py-2"
                                onClick={() => {
                                    setEditingTenant(null);
                                    setShowAddTenant(true);
                                }}
                            >
                                <i className="fas fa-user-plus mr-1"></i>
                                Thêm khách
                            </button>
                            {(nhaTro.khachThue?.length || 0) > 0 && (
                                <button
                                    className="btn btn-success text-sm py-2"
                                    onClick={exportAllTenants}
                                >
                                    <i className="fas fa-file-excel mr-1"></i>
                                    Xuất Excel ({nhaTro.khachThue.length})
                                </button>
                            )}
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {filteredRooms.length === 0 ? (
                            <div className="col-span-full text-center py-12 card">
                                <i className="fas fa-door-open text-6xl text-gray-300 mb-4"></i>
                                <p className="text-gray-500 text-lg">Chưa có phòng nào có khách thuê</p>
                            </div>
                        ) : (
                            filteredRooms.map(room => (
                                <div key={room} className="card p-6">
                                    <div className="flex justify-between items-start mb-4">
                                        <h3 className="text-xl font-bold text-gray-800 flex-1">Phòng {room}</h3>
                                        <span className={`badge ${tenantsByRoom[room].length > 0 ? 'badge-success' : 'badge-warning'}`}>
                                            {tenantsByRoom[room].length} khách
                                        </span>
                                    </div>
                                    <div className="flex gap-2 pt-4 border-t">
                                        <button className="btn btn-primary flex-1 text-sm" onClick={() => setSelectedRoom(room)}>
                                            <i className="fas fa-eye mr-1"></i> Chi tiết
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                    {showAddTenant && (
                        <TenantForm
                            tenant={editingTenant}
                            onSave={addOrUpdateTenant}
                            onCancel={() => {
                                setShowAddTenant(false);
                                setEditingTenant(null);
                            }}
                            defaultAddress={nhaTro.diaChi}
                        />
                    )}
                </div>
            );
        }
        function TenantItem({ tenant, onEdit, onDelete, diaChiNhaTro }) {
            return (
                <div className="tenant-item flex gap-4">
                    <div className="photo-upload flex-shrink-0" style={{ width: '80px', height: '100px' }}>
                        {tenant.anhDaiDien ? (
                            <img src={tenant.anhDaiDien} alt={tenant.hoTen} />
                        ) : (
                            <i className="fas fa-user text-3xl text-gray-400"></i>
                        )}
                    </div>
                    <div className="flex-1 min-w-0">
                        <h5 className="font-bold text-base mb-2">{tenant.hoTen}</h5>
                        <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-gray-600">
                            <div><i className="fas fa-id-card w-4 text-blue-600"></i>{tenant.canCuoc}</div>
                            <div><i className="fas fa-phone w-4 text-green-600"></i>{tenant.soDienThoai}</div>
                            <div><i className="fas fa-briefcase w-4 text-orange-600"></i>{tenant.ngheNghiep || 'N/A'}</div>
                            {tenant.bienSoXe && (
                                <div><i className="fas fa-motorcycle w-4 text-red-600"></i>{tenant.bienSoXe}</div>
                            )}
                            <div className="col-span-2">
                                <i className="fas fa-calendar w-4 text-indigo-600"></i>
                                {formatDate(tenant.ngayThue)} → {formatDate(tenant.ngayTra) || 'Đang thuê'}
                            </div>
                        </div>
                    </div>
                    <div className="flex flex-col gap-2">
                        <button
                            className="btn btn-success text-xs px-3 py-2"
                            onClick={onEdit}
                            title="Chỉnh sửa"
                        >
                            <i className="fas fa-edit"></i>
                        </button>
                        <button
                            className="btn btn-info text-xs px-3 py-2"
                            onClick={() => {
                                const data = [{
                                    'Họ tên': tenant.hoTen,
                                    'Số CCCD': tenant.canCuoc,
                                    'HKTT': tenant.hktt,
                                    'Nơi ở hiện tại': tenant.noiOHienTai,
                                    'Số điện thoại': tenant.soDienThoai,
                                    'Nghề nghiệp': tenant.ngheNghiep,
                                    'Số phòng': tenant.soPhong,
                                    'Loại xe': tenant.loaiXe,
                                    'Biển số xe': tenant.bienSoXe,
                                    'Ngày thuê': formatDate(tenant.ngayThue),
                                    'Ngày trả': formatDate(tenant.ngayTra),
                                    'Địa chỉ nhà trọ': diaChiNhaTro
                                }];
                                exportToExcel(data, `Khach_${tenant.hoTen}_${new Date().toISOString().split('T')[0]}`);
                                alert('✅ Đã xuất Excel thành công!');
                            }}
                            title="Xuất Excel"
                        >
                            <i className="fas fa-file-excel"></i>
                        </button>
                        <button
                            className="btn btn-warning text-xs px-3 py-2"
                            onClick={() => {
                                if (confirm('Chuyển khách này sang danh sách đã trả phòng?')) {
                                    onDelete(tenant.id, true);
                                }
                            }}
                            title="Trả phòng"
                        >
                            <i className="fas fa-sign-out-alt"></i>
                        </button>
                        <button
                            className="btn btn-danger text-xs px-3 py-2"
                            onClick={() => {
                                if (confirm('Xóa thông tin khách này?')) {
                                    onDelete(tenant.id, false);
                                }
                            }}
                            title="Xóa"
                        >
                            <i className="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            );
        }
        function TenantForm({ tenant, onSave, onCancel, defaultAddress }) {
            const [formData, setFormData] = useState(tenant || {
                hoTen: '',
                canCuoc: '',
                hktt: '',
                noiOHienTai: defaultAddress,
                soDienThoai: '',
                ngheNghiep: '',
                bienSoXe: '',
                loaiXe: '',
                ngayThue: new Date().toISOString().split('T')[0],
                ngayTra: '',
                soPhong: '',
                anhDaiDien: ''
            });
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setFormData({ ...formData, anhDaiDien: reader.result });
                    };
                    reader.readAsDataURL(file);
                }
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.hoTen || !formData.canCuoc || !formData.soDienThoai || !formData.soPhong) {
                    alert('Vui lòng điền đầy đủ thông tin bắt buộc (Họ tên, CCCD, SĐT, Số phòng)!');
                    return;
                }
                if (tenant) {
                    onSave({ ...formData, originalId: tenant.id });
                } else {
                    onSave(formData);
                }
            };
            return (
                <div className="modal-overlay" onClick={onCancel}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-2xl font-bold mb-6">
                            <i className={`fas fa-${tenant ? 'edit' : 'user-plus'} text-purple-600 mr-2`}></i>
                            {tenant ? 'Chỉnh sửa thông tin khách thuê' : 'Thêm khách thuê mới'}
                        </h3>
                        <form onSubmit={handleSubmit}>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label className="block text-sm font-semibold mb-2">Ảnh đại diện</label>
                                    <input
                                        type="file"
                                        accept="image/*"
                                        onChange={handleImageUpload}
                                        className="hidden"
                                        id="photoUpload"
                                    />
                                    <label htmlFor="photoUpload" className="photo-upload mx-auto">
                                        {formData.anhDaiDien ? (
                                            <img src={formData.anhDaiDien} alt="Preview" />
                                        ) : (
                                            <div className="text-center text-gray-400">
                                                <i className="fas fa-camera text-3xl mb-2"></i>
                                                <div className="text-xs">Nhấn để tải ảnh</div>
                                            </div>
                                        )}
                                    </label>
                                </div>
                                <div className="md:col-span-2 grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">
                                            Họ tên <span className="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="text"
                                            className="input-field"
                                            value={formData.hoTen}
                                            onChange={(e) => setFormData({...formData, hoTen: e.target.value})}
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">
                                            Số CCCD <span className="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="text"
                                            className="input-field"
                                            value={formData.canCuoc}
                                            onChange={(e) => setFormData({...formData, canCuoc: e.target.value})}
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">HKTT</label>
                                        <input
                                            type="text"
                                            className="input-field"
                                            value={formData.hktt}
                                            onChange={(e) => setFormData({...formData, hktt: e.target.value})}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">
                                            Số điện thoại <span className="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="tel"
                                            className="input-field"
                                            value={formData.soDienThoai}
                                            onChange={(e) => setFormData({...formData, soDienThoai: e.target.value})}
                                            required
                                        />
                                    </div>
                                    <div className="col-span-2">
                                        <label className="block text-sm font-semibold mb-2">Nơi ở hiện tại</label>
                                        <input
                                            type="text"
                                            className="input-field"
                                            value={formData.noiOHienTai}
                                            onChange={(e) => setFormData({...formData, noiOHienTai: e.target.value})}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">Nghề nghiệp</label>
                                        <input
                                            type="text"
                                            className="input-field"
                                            value={formData.ngheNghiep}
                                            onChange={(e) => setFormData({...formData, ngheNghiep: e.target.value})}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">
                                            Số phòng <span className="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="text"
                                            className="input-field"
                                            value={formData.soPhong}
                                            onChange={(e) => setFormData({...formData, soPhong: e.target.value})}
                                            placeholder="VD: 101, A102, 2A..."
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">Loại xe</label>
                                        <input
                                            type="text"
                                            className="input-field"
                                            value={formData.loaiXe}
                                            onChange={(e) => setFormData({...formData, loaiXe: e.target.value})}
                                            placeholder="VD: Xe máy, Ô tô"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">Biển số xe</label>
                                        <input
                                            type="text"
                                            className="input-field"
                                            value={formData.bienSoXe}
                                            onChange={(e) => setFormData({...formData, bienSoXe: e.target.value})}
                                            placeholder="VD: 59A1-12345"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">Ngày thuê</label>
                                        <input
                                            type="date"
                                            className="input-field"
                                            value={formData.ngayThue}
                                            onChange={(e) => setFormData({...formData, ngayThue: e.target.value})}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">Ngày trả (dự kiến)</label>
                                        <input
                                            type="date"
                                            className="input-field"
                                            value={formData.ngayTra}
                                            onChange={(e) => setFormData({...formData, ngayTra: e.target.value})}
                                        />
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-4 justify-end mt-6 pt-6 border-t">
                                <button type="button" className="btn btn-danger" onClick={onCancel}>
                                    <i className="fas fa-times mr-2"></i>
                                    Hủy bỏ
                                </button>
                                <button type="submit" className="btn btn-primary">
                                    <i className="fas fa-save mr-2"></i>
                                    {tenant ? 'Cập nhật' : 'Lưu lại'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
        // Component Khách đã trả phòng
        function KhachDaTraView({ khachDaTra, onBack, onDelete }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [filterNhaTro, setFilterNhaTro] = useState('all');
            const danhSachNhaTro = [...new Set(khachDaTra.map(k => k.tenNhaTro))];
         
            const filtered = khachDaTra.filter(k => {
                const matchSearch = k.hoTen?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                   k.canCuoc?.includes(searchTerm) ||
                                   k.soDienThoai?.includes(searchTerm);
                const matchNhaTro = filterNhaTro === 'all' || k.tenNhaTro === filterNhaTro;
                return matchSearch && matchNhaTro;
            });
            const exportAllKhachDaTra = () => {
                if (filtered.length === 0) {
                    alert('⚠️ Không có dữ liệu để xuất!');
                    return;
                }
             
                const data = filtered.map(k => ({
                    'Họ tên': k.hoTen,
                    'Số CCCD': k.canCuoc,
                    'Số điện thoại': k.soDienThoai,
                    'Nhà trọ': k.tenNhaTro,
                    'Địa chỉ nhà trọ': k.diaChiNhaTro,
                    'Số phòng': k.soPhong,
                    'Nghề nghiệp': k.ngheNghiep || '',
                    'Biển số xe': k.bienSoXe || '',
                    'Ngày thuê': formatDate(k.ngayThue),
                    'Ngày trả': formatDate(k.ngayTraPhong)
                }));
             
                exportToExcel(data, `KhachDaTra_${new Date().toISOString().split('T')[0]}`);
                alert('✅ Đã xuất Excel thành công!');
            };
            return (
                <div className="card p-8">
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-3xl font-bold text-gray-800">
                                <i className="fas fa-history text-purple-600 mr-3"></i>
                                Khách đã trả phòng
                            </h2>
                            <p className="text-gray-600 mt-1">Lưu trữ thông tin khách đã trả phòng</p>
                        </div>
                        <div className="flex gap-3">
                            {filtered.length > 0 && (
                                <button className="btn btn-success" onClick={exportAllKhachDaTra}>
                                    <i className="fas fa-file-excel mr-2"></i>
                                    Xuất Excel ({filtered.length})
                                </button>
                            )}
                            <button className="btn btn-danger" onClick={onBack}>
                                <i className="fas fa-arrow-left mr-2"></i>
                                Quay lại
                            </button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div className="relative">
                            <i className="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input
                                type="text"
                                placeholder="Tìm kiếm theo tên, CCCD, SĐT..."
                                className="input-field pl-12"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                        <select
                            className="input-field"
                            value={filterNhaTro}
                            onChange={(e) => setFilterNhaTro(e.target.value)}
                        >
                            <option value="all">Tất cả nhà trọ</option>
                            {danhSachNhaTro.map(nt => (
                                <option key={nt} value={nt}>{nt}</option>
                            ))}
                        </select>
                    </div>
                    <div className="space-y-4">
                        {filtered.length === 0 ? (
                            <div className="text-center py-12 bg-gray-50 rounded-lg">
                                <i className="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                                <p className="text-gray-500">Không có khách đã trả phòng</p>
                            </div>
                        ) : (
                            filtered.map(khach => (
                                <div key={khach.id} className="card p-4 flex gap-4">
                                    <div className="photo-upload flex-shrink-0">
                                        {khach.anhDaiDien ? (
                                            <img src={khach.anhDaiDien} alt={khach.hoTen} />
                                        ) : (
                                            <i className="fas fa-user text-4xl text-gray-400"></i>
                                        )}
                                    </div>
                                    <div className="flex-1">
                                        <div className="flex justify-between items-start mb-2">
                                            <h5 className="font-bold text-lg">{khach.hoTen}</h5>
                                            <span className="badge badge-danger">Đã trả phòng</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-x-8 gap-y-1 text-sm text-gray-600">
                                            <div><i className="fas fa-building w-5 text-purple-600"></i>{khach.tenNhaTro}</div>
                                            <div><i className="fas fa-door-open w-5 text-blue-600"></i>Phòng {khach.soPhong}</div>
                                            <div><i className="fas fa-id-card w-5 text-green-600"></i>{khach.canCuoc}</div>
                                            <div><i className="fas fa-phone w-5 text-orange-600"></i>{khach.soDienThoai}</div>
                                            <div><i className="fas fa-calendar-check w-5 text-indigo-600"></i>Thuê: {formatDate(khach.ngayThue)}</div>
                                            <div><i className="fas fa-calendar-times w-5 text-red-600"></i>Trả: {formatDate(khach.ngayTraPhong)}</div>
                                        </div>
                                        <button
                                            className="btn btn-danger text-sm mt-3"
                                            onClick={() => {
                                                if (confirm('Xóa vĩnh viễn thông tin khách này?')) {
                                                    onDelete(khach.id);
                                                }
                                            }}
                                        >
                                            <i className="fas fa-trash mr-1"></i>
                                            Xóa vĩnh viễn
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        }
        // Component Tìm kiếm toàn cục
        function GlobalSearchView({ nhaTros, khachDaTra, onBack }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [searchType, setSearchType] = useState('all');
            const [results, setResults] = useState([]);
            const [hasSearched, setHasSearched] = useState(false);
            const handleSearch = () => {
                if (!searchTerm.trim()) {
                    alert('Vui lòng nhập từ khóa tìm kiếm!');
                    return;
                }
                const term = searchTerm.toLowerCase().trim();
                const allResults = [];
                nhaTros.forEach(nhaTro => {
                    (nhaTro.khachThue || []).forEach(khach => {
                        let match = false;
                        if (searchType === 'all' || searchType === 'name') {
                            if (khach.hoTen?.toLowerCase().includes(term)) match = true;
                        }
                        if (searchType === 'all' || searchType === 'cccd') {
                            if (khach.canCuoc?.includes(term)) match = true;
                        }
                        if (searchType === 'all' || searchType === 'bienso') {
                            if (khach.bienSoXe?.toLowerCase().includes(term)) match = true;
                        }
                        if (match) {
                            allResults.push({
                                ...khach,
                                tenNhaTro: nhaTro.tenNhaTro,
                                diaChiNhaTro: nhaTro.diaChi,
                                trangThai: 'Đang thuê'
                            });
                        }
                    });
                });
                khachDaTra.forEach(khach => {
                    let match = false;
                    if (searchType === 'all' || searchType === 'name') {
                        if (khach.hoTen?.toLowerCase().includes(term)) match = true;
                    }
                    if (searchType === 'all' || searchType === 'cccd') {
                        if (khach.canCuoc?.includes(term)) match = true;
                    }
                    if (searchType === 'all' || searchType === 'bienso') {
                        if (khach.bienSoXe?.toLowerCase().includes(term)) match = true;
                    }
                    if (match) {
                        allResults.push({
                            ...khach,
                            trangThai: 'Đã trả phòng'
                        });
                    }
                });
                setResults(allResults);
                setHasSearched(true);
            };
            return (
                <div className="card p-8">
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-3xl font-bold text-gray-800">
                                <i className="fas fa-search-plus text-purple-600 mr-3"></i>
                                Tìm kiếm toàn cục
                            </h2>
                            <p className="text-gray-600 mt-1">Tìm kiếm khách thuê trong tất cả nhà trọ</p>
                        </div>
                        <button className="btn btn-danger" onClick={onBack}>
                            <i className="fas fa-arrow-left mr-2"></i>
                            Quay lại
                        </button>
                    </div>
                    <div className="card p-6 mb-6 bg-gradient-to-r from-purple-50 to-blue-50">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div className="md:col-span-2">
                                <label className="block text-sm font-semibold mb-2">Từ khóa tìm kiếm</label>
                                <input
                                    type="text"
                                    className="input-field"
                                    placeholder="Nhập tên, CCCD, hoặc biển số xe..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold mb-2">Tìm theo</label>
                                <select
                                    className="input-field"
                                    value={searchType}
                                    onChange={(e) => setSearchType(e.target.value)}
                                >
                                    <option value="all">Tất cả</option>
                                    <option value="name">Họ tên</option>
                                    <option value="cccd">Số CCCD</option>
                                    <option value="bienso">Biển số xe</option>
                                </select>
                            </div>
                            <div className="flex items-end">
                                <button
                                    className="btn btn-primary w-full"
                                    onClick={handleSearch}
                                >
                                    <i className="fas fa-search mr-2"></i>
                                    Tìm kiếm
                                </button>
                            </div>
                        </div>
                    </div>
                    <div>
                        {!hasSearched ? (
                            <div className="text-center py-16 bg-gray-50 rounded-lg">
                                <i className="fas fa-search text-6xl text-gray-300 mb-4"></i>
                                <p className="text-gray-500 text-lg">Nhập thông tin và nhấn tìm kiếm</p>
                            </div>
                        ) : results.length === 0 ? (
                            <div className="text-center py-16 bg-gray-50 rounded-lg">
                                <i className="fas fa-user-slash text-6xl text-gray-300 mb-4"></i>
                                <p className="text-gray-500 text-lg">Không tìm thấy kết quả nào</p>
                                <p className="text-gray-400 text-sm mt-2">Hãy thử với từ khóa khác</p>
                            </div>
                        ) : (
                            <div>
                                <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <i className="fas fa-check-circle text-green-600 mr-2"></i>
                                    <span className="font-semibold text-green-800">
                                        Tìm thấy {results.length} kết quả
                                    </span>
                                </div>
                                <div className="space-y-4">
                                    {results.map((result, index) => (
                                        <SearchResultCard key={index} result={result} searchTerm={searchTerm} />
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        function SearchResultCard({ result, searchTerm }) {
            const highlightText = (text) => {
                if (!text || !searchTerm) return text;
                const regex = new RegExp(`(${searchTerm})`, 'gi');
                const parts = text.split(regex);
                return parts.map((part, i) =>
                    regex.test(part) ? <span key={i} className="highlight">{part}</span> : part
                );
            };
            return (
                <div className="search-result-card">
                    <div className="flex gap-4">
                        <div className="photo-upload flex-shrink-0">
                            {result.anhDaiDien ? (
                                <img src={result.anhDaiDien} alt={result.hoTen} />
                            ) : (
                                <i className="fas fa-user text-4xl text-gray-400"></i>
                            )}
                        </div>
                        <div className="flex-1">
                            <div className="flex justify-between items-start mb-3">
                                <h4 className="text-xl font-bold text-gray-800">
                                    {highlightText(result.hoTen)}
                                </h4>
                                <span className={`badge ${result.trangThai === 'Đang thuê' ? 'badge-success' : 'badge-danger'}`}>
                                    {result.trangThai}
                                </span>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <h5 className="font-semibold text-sm text-gray-700 uppercase">Thông tin cá nhân</h5>
                                    <div className="text-sm space-y-1">
                                        <div>
                                            <span className="font-semibold">Số CCCD:</span>{' '}
                                            <span>{highlightText(result.canCuoc)}</span>
                                        </div>
                                        <div>
                                            <span className="font-semibold">HKTT:</span> {result.hktt || 'N/A'}
                                        </div>
                                        <div>
                                            <span className="font-semibold">Số điện thoại:</span> {result.soDienThoai}
                                        </div>
                                        {result.bienSoXe && (
                                            <div>
                                                <span className="font-semibold">Biển số xe:</span>{' '}
                                                <span>{highlightText(result.bienSoXe)}</span> ({result.loaiXe})
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <h5 className="font-semibold text-sm text-gray-700 uppercase">Thông tin thuê trọ</h5>
                                    <div className="text-sm space-y-1">
                                        <div>
                                            <span className="font-semibold">Nhà trọ:</span> {result.tenNhaTro}
                                        </div>
                                        <div>
                                            <span className="font-semibold">Địa chỉ:</span> {result.diaChiNhaTro}
                                        </div>
                                        <div>
                                            <span className="font-semibold">Số phòng:</span> {result.soPhong}
                                        </div>
                                        <div>
                                            <span className="font-semibold">Ngày thuê:</span> {formatDate(result.ngayThue)}
                                        </div>
                                        {result.ngayTraPhong && (
                                            <div>
                                                <span className="font-semibold">Ngày trả:</span> {formatDate(result.ngayTraPhong)}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        ReactDOM.render(<QuanLyNhaTro />, document.getElementById('root'));
    </script>
</body>
</html>